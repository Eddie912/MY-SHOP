// const products = [
//   {
//     "id": 1,
//     "name": "卫生棺",
//     "price": 190,
//     "image": "images/卫生棺.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 2,
//     "name": "天堂礼花（1米）",
//     "price": 20,
//     "image": "images/天堂礼花（1米）.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 3,
//     "name": "陶瓷纤维毯",
//     "price": 26,
//     "image": "images/陶瓷纤维毯.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 4,
//     "name": "望山钱纸",
//     "price": 20,
//     "image": "images/望山钱纸.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 5,
//     "name": "A3相框",
//     "price": 27,
//     "image": "images/A3相框.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 6,
//     "name": "A4相框",
//     "price": 22,
//     "image": "images/A4相框.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 7,
//     "name": "托盘",
//     "price": 28,
//     "image": "images/托盘.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 8,
//     "name": "送明灯笼",
//     "price": 25,
//     "image": "images/送明灯笼.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 9,
//     "name": "遗体卫生袋",
//     "price": 50,
//     "image": "images/遗体卫生袋.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 10,
//     "name": "灵幡",
//     "price": 13,
//     "image": "images/灵幡.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 11,
//     "name": "袋香",
//     "price": 0,
//     "image": "images/袋香.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 12,
//     "name": "平安香",
//     "price": 1,
//     "image": "images/平安香.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 13,
//     "name": "小白花",
//     "price": 0,
//     "image": "images/小白花.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 14,
//     "name": "奠字方巾",
//     "price": 4,
//     "image": "images/奠字方巾.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 15,
//     "name": "骨灰收集袋",
//     "price": 4,
//     "image": "images/骨灰收集袋.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 16,
//     "name": "酥油（2公升）",
//     "price": 28,
//     "image": "images/酥油（2公升）.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 17,
//     "name": "保护罩",
//     "price": 90,
//     "image": "images/保护罩.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 18,
//     "name": "护灵灯笼花",
//     "price": 10,
//     "image": "images/护灵灯笼花.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 19,
//     "name": "三天酥油斗烛",
//     "price": 27,
//     "image": "images/三天酥油斗烛.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 20,
//     "name": "骨灰识别牌",
//     "price": 25,
//     "image": "images/骨灰识别牌.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 21,
//     "name": "平安带",
//     "price": 0,
//     "image": "images/平安带.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 22,
//     "name": "黄绸感恩被",
//     "price": 100,
//     "image": "images/黄绸感恩被.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 23,
//     "name": "骨灰防潮剂",
//     "price": 3,
//     "image": "images/骨灰防潮剂.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 24,
//     "name": "黑伞",
//     "price": 20,
//     "image": "images/黑伞.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 25,
//     "name": "大白花",
//     "price": 4,
//     "image": "images/大白花.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 26,
//     "name": "大相框花",
//     "price": 2,
//     "image": "images/大相框花（A3）.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 27,
//     "name": "小相框花",
//     "price": 1,
//     "image": "images/小相框花（A4）.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 28,
//     "name": "除味剂",
//     "price": 16,
//     "image": "images/遗体除味剂.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 29,
//     "name": "龙香(1.8尺）",
//     "price": 0.6,
//     "image": "images/龙香(1.8尺）.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 30,
//     "name": "祈福香",
//     "price": 0.8,
//     "image": "images/祈福香.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 31,
//     "name": "祈福灯蜡",
//     "price": 0,
//     "image": "images/祈福灯蜡.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 32,
//     "name": "防风长明灯",
//     "price": 22,
//     "image": "images/防风长明灯.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 33,
//     "name": "A4打印纸",
//     "price": 20,
//     "image": "images/A4打印纸.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 34,
//     "name": "1520写真纸",
//     "price": 270,
//     "image": "images/1520写真纸.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 35,
//     "name": "A5打印纸",
//     "price": 13,
//     "image": "images/A5打印纸.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 36,
//     "name": "写真机墨水-黑色（BK）",
//     "price": 110,
//     "image": "images/写真机黑色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 37,
//     "name": "写真机墨水-黄色（Y）",
//     "price": 110,
//     "image": "images/写真机黄色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 38,
//     "name": "写真机墨水-品红（M）",
//     "price": 110,
//     "image": "images/写真机红色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 39,
//     "name": "写真机墨水-青色（C）",
//     "price": 110,
//     "image": "images/写真机青色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 40,
//     "name": "南孚2号电池",
//     "price": 7,
//     "image": "images/南孚2号电池.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 41,
//     "name": "南孚5号电池",
//     "price": 2,
//     "image": "images/南孚5号电池.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 42,
//     "name": "南孚7号电池",
//     "price": 2,
//     "image": "images/南孚7号电池.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 43,
//     "name": "封口胶",
//     "price": 9,
//     "image": "images/封口胶.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 44,
//     "name": "A3相纸",
//     "price": 20,
//     "image": "images/A3相纸.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 45,
//     "name": "002黑色墨水",
//     "price": 70,
//     "image": "images/002黑色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 46,
//     "name": "002红色墨水",
//     "price": 45,
//     "image": "images/002红色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 47,
//     "name": "002青色墨水",
//     "price": 45,
//     "image": "images/002蓝色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 48,
//     "name": "002黄色墨水",
//     "price": 45,
//     "image": "images/002黄色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 49,
//     "name": "859黑色墨水",
//     "price": 90,
//     "image": "images/859黑色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 50,
//     "name": "004黑色墨水",
//     "price": 32,
//     "image": "images/004黑色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 51,
//     "name": "004蓝色墨水",
//     "price": 41,
//     "image": "images/004蓝色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 52,
//     "name": "004红色墨水",
//     "price": 41,
//     "image": "images/004红色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 53,
//     "name": "004黄色墨水",
//     "price": 41,
//     "image": "images/004黄色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 54,
//     "name": "066黑色墨水",
//     "price": 100,
//     "image": "images/066黑色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 55,
//     "name": "066红色墨水",
//     "price": 95,
//     "image": "images/066红色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 56,
//     "name": "066蓝色墨水",
//     "price": 95,
//     "image": "images/066蓝色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 57,
//     "name": "066黄色墨水",
//     "price": 95,
//     "image": "images/066黄色墨水.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 58,
//     "name": "一次性PE手套",
//     "price": 0,
//     "image": "images/一次性PE手套.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 59,
//     "name": "高邦橡胶手套",
//     "price": 2,
//     "image": "images/高邦橡胶手套.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 60,
//     "name": "75度酒精",
//     "price": 5,
//     "image": "images/75度酒精.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 61,
//     "name": "一次性手术衣",
//     "price": 4,
//     "image": "images/一次性手术衣.jpg",
//     "category": "funeral_supplies"
//   },
//   {
//     "id": 62,
//     "name": "医用外科口罩",
//     "price": 0,
//     "image": "images/医用外科口罩.jpg",
//     "category": "funeral_supplies"
//   }
// ];

let products = [];
// 购物车和状态管理
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let currentCategory = 'all';
let currentSearch = '';

// DOM加载完成后初始化
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('./products.json');
        if (!response.ok) throw new Error('JSON文件加载失败');
        
        // 解析 JSON 数据
        products = await response.json();
        
        // 原有初始化逻辑（这部分代码保留，只是移到 fetch 成功后）
        updateCartCount(); 
        renderProducts();
        document.querySelector('.categories button:first-child').classList.add('active');
        
        // 搜索框回车事件（保留）
        document.getElementById('search-input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchProducts();
            }
        });
    } catch (error) {
        // 新增：加载失败的提示
        console.error('商品数据加载失败：', error);
        const productsContainer = document.querySelector('.products');
        productsContainer.innerHTML = '<p class="no-products">商品数据加载失败，请刷新页面重试</p>';
    }
});

// 渲染商品列表
function renderProducts() {
    const productsContainer = document.querySelector('.products');
    productsContainer.innerHTML = '';
    
    // 应用筛选和搜索
    let filteredProducts = applyFilters();
    
    if (filteredProducts.length === 0) {
        productsContainer.innerHTML = '<p class="no-products">没有找到符合条件的商品</p >';
        return;
    }
    
    // 渲染每个商品
    filteredProducts.forEach(product => {
        const productElement = document.createElement('div');
        productElement.className = 'product';
        productElement.innerHTML = `
            <div class="product-image-container">
                <img class="product-image lazy" src="https://cdn.jsdelivr.net/gh/Eddie912/MY-SHOP@main/${product.image}" alt="${product.name}">
            </div>
            <h3 class="product-name">${product.name}</h3>
            <p class="product-price">¥${product.price.toFixed(2)}</p>
            <div class="add-to-cart">
                <input type="number" id="qty-${product.id}" min="1" value="1" class="quantity-input">
                <button onclick="addToCart(${product.id})" class="add-cart-btn">加入购物车</button>
            </div>
        `;
        productsContainer.appendChild(productElement);
    });
}
// 应用分类和搜索筛选
function applyFilters() {
    let result = [...products];
    
    // 分类筛选
    if (currentCategory !== 'all') {
        result = result.filter(product => product.category === currentCategory);
    }
    
    // 搜索筛选
    if (currentSearch) {
        const searchTerm = currentSearch.toLowerCase();
        result = result.filter(product => 
            product.name.toLowerCase().includes(searchTerm)
        );
    }
    
    return result;
}

// 分类筛选
function filterProducts(category) {
    currentCategory = category;
    currentSearch = '';
    document.getElementById('search-input').value = '';
    
    // 更新分类按钮状态
    document.querySelectorAll('.categories button').forEach(button => {
        button.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderProducts();
}

// 商品搜索
function searchProducts() {
    currentSearch = document.getElementById('search-input').value.trim();
    currentCategory = 'all';
    
    // 重置分类按钮状态
    document.querySelectorAll('.categories button').forEach(button => {
        button.classList.remove('active');
    });
    document.querySelector('.categories button:first-child').classList.add('active');
    
    renderProducts();
}

// 添加到购物车
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    const quantityInput = document.getElementById(`qty-${productId}`);
    let quantity = parseInt(quantityInput.value);
    
    // 验证数量
    if (isNaN(quantity) || quantity < 1) {
        quantity = 1;
        quantityInput.value = 1;
    }
    
    // 更新购物车
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: quantity
        });
    }
    
    // 保存并更新UI
    saveCart();
    showNotification(`${product.name} ×${quantity} 已添加到购物车`);
}

// 保存购物车到本地存储
function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
}

// 更新购物车数量显示
function updateCartCount() {
    const count = cart.reduce((total, item) => total + item.quantity, 0);
    document.getElementById('cart-count').textContent = count;
}

// 显示通知消息
function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // 自动消失
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 500);
    }, 2000);
}